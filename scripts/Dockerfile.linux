# Dockerfile for Headless Linux builds (CLI and Server with Web UI)
# This Dockerfile is designed to be used with docker buildx

# Stage 1: Build the backend and frontend
FROM rust:bookworm AS builder

# TARGETARCH is automatically set by Docker Buildx (amd64, arm64, etc.)
ARG TARGETARCH
ARG BUILD_VERSION=0.0.0

# Install essential system dependencies for backend (PDF extraction, SSL, etc.)
RUN apt-get update && apt-get install -y \
    libssl-dev \
    libpoppler-glib-dev \
    pkg-config \
    cmake \
    curl \
    protobuf-compiler \
    libclang-dev \
    && rm -rf /var/lib/apt/lists/*

# Install Node.js 20 for frontend build
RUN curl -fsSL https://deb.nodesource.com/setup_20.x | bash - \
    && apt-get install -y nodejs

WORKDIR /app

# 1. Pre-build backend dependencies for caching
# We copy manifests first to cache dependencies
COPY backend/Cargo.toml backend/Cargo.lock backend/
COPY backend/api/Cargo.toml backend/api/
COPY backend/architect/Cargo.toml backend/architect/
COPY backend/context/Cargo.toml backend/context/
COPY backend/core/Cargo.toml backend/core/
COPY backend/embeddings/Cargo.toml backend/embeddings/
COPY backend/enhancement/Cargo.toml backend/enhancement/
COPY backend/ingestion/Cargo.toml backend/ingestion/
COPY backend/intent/Cargo.toml backend/intent/
COPY backend/llm/Cargo.toml backend/llm/
COPY backend/storage/Cargo.toml backend/storage/
COPY backend/mcp-server/Cargo.toml backend/mcp-server/

# Create dummy source files for all backend crates
RUN mkdir -p backend/api/src && echo "fn main() {}" > backend/api/src/main.rs && \
    mkdir -p backend/architect/src && touch backend/architect/src/lib.rs && \
    mkdir -p backend/context/src && touch backend/context/src/lib.rs && \
    mkdir -p backend/core/src && touch backend/core/src/lib.rs && \
    mkdir -p backend/embeddings/src && touch backend/embeddings/src/lib.rs && \
    mkdir -p backend/enhancement/src && touch backend/enhancement/src/lib.rs && \
    mkdir -p backend/ingestion/src && touch backend/ingestion/src/lib.rs && \
    mkdir -p backend/intent/src && touch backend/intent/src/lib.rs && \
    mkdir -p backend/llm/src && touch backend/llm/src/lib.rs && \
    mkdir -p backend/storage/src && touch backend/storage/src/lib.rs && \
    mkdir -p backend/mcp-server/src && echo "fn main() {}" > backend/mcp-server/src/main.rs

WORKDIR /app/backend
RUN cargo build --release -p api

# 2. Pre-build CLI dependencies for caching
WORKDIR /app
COPY linggen-cli/Cargo.toml linggen-cli/Cargo.lock linggen-cli/
RUN mkdir -p linggen-cli/src && echo "fn main() {}" > linggen-cli/src/main.rs
WORKDIR /app/linggen-cli
RUN cargo build --release

# 3. Now copy the whole project and build the real binaries
WORKDIR /app
COPY . .

# Invalidate cache for final builds if version changes
ARG BUILD_VERSION
ENV LINGGEN_BUILD_VERSION=$BUILD_VERSION

# Build the real backend binary
WORKDIR /app/backend
RUN cargo build --release -p api

# Build the real CLI binary
WORKDIR /app/linggen-cli
RUN cargo build --release

# 4. Build the frontend assets
WORKDIR /app/frontend
# Copy package files first for caching
COPY frontend/package.json ./
# Remove lockfile to avoid architecture mismatches during multi-arch builds
RUN rm -f package-lock.json && npm install
COPY frontend/ .
RUN npm run build

# 5. Prepare portable artifacts
WORKDIR /app
RUN mkdir -p /app/dist-temp && \
    if [ "$TARGETARCH" = "amd64" ]; then SLUG="x86_64"; else SLUG="aarch64"; fi && \
    # CLI Tarball (Flat)
    mkdir -p /app/dist-temp/cli-flat && \
    cp /app/linggen-cli/target/release/linggen /app/dist-temp/cli-flat/ && \
    cd /app/dist-temp/cli-flat && tar -czf /app/dist-temp/linggen-cli-linux-${SLUG}.tar.gz linggen && \
    # Server Tarball (Portable with root folder)
    mkdir -p /app/dist-temp/linggen-server-linux-${SLUG}/frontend && \
    mkdir -p /app/dist-temp/linggen-server-linux-${SLUG}/library_templates && \
    cp /app/backend/target/release/linggen-server /app/dist-temp/linggen-server-linux-${SLUG}/ && \
    cp -r /app/frontend/dist/* /app/dist-temp/linggen-server-linux-${SLUG}/frontend/ && \
    cp -r /app/backend/api/library_templates/* /app/dist-temp/linggen-server-linux-${SLUG}/library_templates/ && \
    cd /app/dist-temp && tar -czf /app/dist-temp/linggen-server-linux-${SLUG}.tar.gz linggen-server-linux-${SLUG}

# Stage 2: Artifact extraction
FROM scratch AS artifacts
COPY --from=builder /app/dist-temp/*.tar.gz /
