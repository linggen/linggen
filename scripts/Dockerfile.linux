# Dockerfile for Headless Linux builds (CLI and Server with embedded Web UI)
# This Dockerfile is designed to be used with docker buildx

# Stage 1: Build the backend and frontend
FROM rust:bookworm AS builder

# TARGETARCH is automatically set by Docker Buildx (amd64, arm64, etc.)
ARG TARGETARCH
ARG BUILD_VERSION=0.0.0

# Install essential system dependencies for backend (PDF extraction, SSL, etc.)
RUN apt-get update && apt-get install -y \
    libssl-dev \
    libpoppler-glib-dev \
    pkg-config \
    cmake \
    curl \
    protobuf-compiler \
    libclang-dev \
    && rm -rf /var/lib/apt/lists/*

# Install Node.js 20 for frontend build
RUN curl -fsSL https://deb.nodesource.com/setup_20.x | bash - \
    && apt-get install -y nodejs

WORKDIR /app

# 1. Pre-build backend dependencies for caching
# We copy manifests first to cache dependencies
COPY backend/Cargo.toml backend/Cargo.lock backend/
COPY backend/api/Cargo.toml backend/api/
COPY backend/architect/Cargo.toml backend/architect/
COPY backend/context/Cargo.toml backend/context/
COPY backend/core/Cargo.toml backend/core/
COPY backend/embeddings/Cargo.toml backend/embeddings/
COPY backend/enhancement/Cargo.toml backend/enhancement/
COPY backend/ingestion/Cargo.toml backend/ingestion/
COPY backend/intent/Cargo.toml backend/intent/
COPY backend/llm/Cargo.toml backend/llm/
COPY backend/storage/Cargo.toml backend/storage/
COPY backend/mcp-server/Cargo.toml backend/mcp-server/

# Create dummy source files for all backend crates
RUN mkdir -p backend/api/src && echo "fn main() {}" > backend/api/src/main.rs && \
    mkdir -p backend/architect/src && touch backend/architect/src/lib.rs && \
    mkdir -p backend/context/src && touch backend/context/src/lib.rs && \
    mkdir -p backend/core/src && touch backend/core/src/lib.rs && \
    mkdir -p backend/embeddings/src && touch backend/embeddings/src/lib.rs && \
    mkdir -p backend/enhancement/src && touch backend/enhancement/src/lib.rs && \
    mkdir -p backend/ingestion/src && touch backend/ingestion/src/lib.rs && \
    mkdir -p backend/intent/src && touch backend/intent/src/lib.rs && \
    mkdir -p backend/llm/src && touch backend/llm/src/lib.rs && \
    mkdir -p backend/storage/src && touch backend/storage/src/lib.rs && \
    mkdir -p backend/mcp-server/src && echo "fn main() {}" > backend/mcp-server/src/main.rs

WORKDIR /app/backend
RUN cargo build --release -p api

# 2. Pre-build CLI dependencies for caching
WORKDIR /app
COPY linggen-cli/Cargo.toml linggen-cli/Cargo.lock linggen-cli/
RUN mkdir -p linggen-cli/src && echo "fn main() {}" > linggen-cli/src/main.rs
WORKDIR /app/linggen-cli
RUN cargo build --release

# 3. Now copy the whole project
WORKDIR /app
COPY . .

# 4. Build the frontend assets (MUST happen before server build for embedding)
WORKDIR /app/frontend
# Remove lockfile to avoid architecture mismatches during multi-arch builds
RUN rm -f package-lock.json && npm install
RUN npm run build && [ "$(ls -A dist)" ] || (echo "❌ Error: Frontend build produced no assets" && exit 1)

# 5. Build the real binaries
# Invalidate cache for final builds if version changes
ARG BUILD_VERSION
ENV LINGGEN_BUILD_VERSION=$BUILD_VERSION

# Build the real backend binary (with embedded UI)
WORKDIR /app/backend
RUN find . -name "*.rs" -exec touch {} + && cargo build --release -p api

# Build the real CLI binary
WORKDIR /app/linggen-cli
RUN find src -name "*.rs" -exec touch {} + && cargo build --release

# 6. Prepare portable artifacts
WORKDIR /app
RUN mkdir -p /app/dist-temp && \
    if [ "$TARGETARCH" = "amd64" ]; then SLUG="x86_64"; else SLUG="aarch64"; fi && \
    # CLI validation
    CLI_BIN="/app/linggen-cli/target/release/linggen" && \
    CLI_SIZE=$(stat -c%s "$CLI_BIN") && \
    if [ "$CLI_SIZE" -lt 1000000 ]; then echo "❌ Error: CLI binary too small ($CLI_SIZE bytes)" && exit 1; fi && \
    # CLI Tarball (Flat)
    mkdir -p /app/dist-temp/cli-flat && \
    cp "$CLI_BIN" /app/dist-temp/cli-flat/ && \
    cd /app/dist-temp/cli-flat && tar -czf /app/dist-temp/linggen-cli-linux-${SLUG}.tar.gz linggen && \
    # Server validation
    SRV_BIN="/app/backend/target/release/linggen-server" && \
    SRV_SIZE=$(stat -c%s "$SRV_BIN") && \
    if [ "$SRV_SIZE" -lt 10000000 ]; then echo "❌ Error: Server binary too small ($SRV_SIZE bytes)" && exit 1; fi && \
    # Server Tarball (Portable with root folder)
    SRV_DIST_NAME="linggen-server-linux-${SLUG}" && \
    mkdir -p /app/dist-temp/${SRV_DIST_NAME} && \
    cp "$SRV_BIN" /app/dist-temp/${SRV_DIST_NAME}/ && \
    cd /app/dist-temp && tar -czf /app/dist-temp/linggen-server-linux-${SLUG}.tar.gz ${SRV_DIST_NAME}

# Stage 2: Artifact extraction
FROM scratch AS artifacts
COPY --from=builder /app/dist-temp/*.tar.gz /
